trigger:
- uat # change to your branch

variables:
  containerRegistryConection: 'app-nonprod-registry'
  deploymentFileName: 'authserviceuat-deployment.yaml'
  imageName: 'btg-labware-auth-service'
  environment: 'uat'
  pool: 'GCP-NONPRD-POOL'
  GCP_PROJECT_ID: 'app-nonprod-project'
  GCP_REPO: 'app-nonprod-ar'
  updateK8sScriptFile: 'updateK8smanifest.sh'
  containerImageRepository: 'asia-southeast1-docker.pkg.dev/$(GCP_PROJECT_ID)/$(GCP_REPO)/$(imageName)'
  k8sManifestRepoUrl: 'git@ssh.dev.azure.com:v3/betagro-dev/Labware-hemagglutinatio_inhibition_test_automation/Manifest'
  # CI
stages:
- stage: Build
  displayName: Build stage
  condition: succeeded()
  jobs:
  - job: Build
    displayName: Build Job
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "Source Version: $(Build.SourceVersion)"
        commitHash=$(echo "$(Build.SourceVersion)" | cut -c1-8)
        echo "Commit Hash (8-digit): $commitHash"
        echo "##vso[task.setvariable variable=commitHash]$commitHash"
      displayName: Get Git Commit Hash (8-digit)

    - task: Docker@2
      displayName: Login to DEV ACR
      inputs:
        command: login
        containerRegistry: '$(containerRegistryConection)'

    - task: Bash@3
      displayName: Pulling docker image from DEV ACR
      inputs:
        targetType: inline
        script: |
          docker pull $(containerImageRepository):dev-$(Build.SourceVersion)

    - task: Bash@3
      displayName: Retag the image and push
      inputs:
        targetType: inline
        script: |
          docker tag $(containerImageRepository):dev-$(Build.SourceVersion) $(containerImageRepository):uat-$(Build.SourceVersion)
          docker push $(containerImageRepository):uat-$(Build.SourceVersion)

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: drop'

- stage: Update
  displayName: Update K8s Manifests
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: UpdateManifests
    displayName: Update K8s Manifests
    pool:
      name: $(pool)
    steps:
    - checkout: self
      displayName: 'Checkout source code'

    # FIX: Add this step to fix line endings
    - task: Bash@3
      displayName: 'Fix Script Line Endings'
      inputs:
        targetType: 'inline'
        script: |
          echo "Fixing line endings in $(updateK8sScriptFile)..."
          # Remove Windows carriage returns
          sed -i 's/\r$//' $(System.DefaultWorkingDirectory)/$(updateK8sScriptFile)
          # Make script executable
          chmod +x $(System.DefaultWorkingDirectory)/$(updateK8sScriptFile)
          # Verify the fix
          echo "Verifying file..."
          file $(System.DefaultWorkingDirectory)/$(updateK8sScriptFile)
          echo "First 3 lines:"
          head -3 $(System.DefaultWorkingDirectory)/$(updateK8sScriptFile)
        workingDirectory: '$(System.DefaultWorkingDirectory)'

    - task: Bash@3
      displayName: 'Update K8s Manifest'
      inputs:
        targetType: 'filePath'
        filePath: '$(System.DefaultWorkingDirectory)/$(updateK8sScriptFile)'
        arguments: '$(environment) uat-$(Build.SourceVersion) $(containerImageRepository) $(k8sManifestRepoUrl) $(deploymentFileName)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        # failOnStderr: true
      env:
        ENVIRONMENT: $(environment)
        IMAGE_TAG: uat-$(Build.SourceVersion)
        CONTAINER_REGISTRY: $(containerImageRepository)
        K8S_MANIFEST_REPO: $(k8sManifestRepoUrl)
        DEPLOYMENT_FILE_NAME: $(deploymentFileName)
